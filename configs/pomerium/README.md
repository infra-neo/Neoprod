# Pomerium Configuration

This directory contains the configuration files for Pomerium Zero Trust Proxy integrated with Zitadel authentication and Netbird mesh network.

## Files

- `docker-compose.yml`: Docker Compose configuration for Pomerium
- `config.yaml`: Pomerium routes and policy configuration
- `.env.template`: Environment variables template (copy to `.env` and fill in)

## Quick Start

### 1. Copy configuration to VM2

```bash
# SSH to VM2
gcloud compute ssh pomerium-proxy-vm2 --zone us-central1-a

# Create directories
sudo mkdir -p /opt/pomerium/config

# Copy files
sudo cp docker-compose.yml /opt/pomerium/
sudo cp config.yaml /opt/pomerium/config/
```

### 2. Configure environment variables

```bash
# Copy template
sudo cp .env.template /opt/pomerium/.env

# Edit with your Zitadel credentials
sudo nano /opt/pomerium/.env
```

Required variables:
- `ZITADEL_CLIENT_ID`: Client ID from Zitadel application
- `ZITADEL_CLIENT_SECRET`: Client secret from Zitadel application
- Secrets are auto-generated by bootstrap script

### 3. Configure Netbird

```bash
# Get setup key from Netbird dashboard on VM1
sudo netbird up --setup-key <YOUR_SETUP_KEY>
```

### 4. Start Pomerium

```bash
sudo systemctl start pomerium
# Or
sudo /opt/pomerium/start.sh
```

### 5. Verify

```bash
# Check status
docker ps

# View logs
sudo /opt/pomerium/logs.sh

# Check Netbird connection
netbird status
```

## Configuration

### Adding a New Application Route

Edit `/opt/pomerium/config/config.yaml`:

```yaml
routes:
  - from: https://myapp.pomerium.local
    to: http://myapp-backend.internal:8080
    pass_identity_headers: true
    set_request_headers:
      X-Pomerium-Claim-Email: "${pomerium.email}"
      X-Pomerium-Claim-Groups: "${pomerium.groups}"
    policy:
      - allow:
          groups:
            is: myapp-users
    show_in_routes_portal: true
```

Restart Pomerium:
```bash
sudo /opt/pomerium/restart.sh
```

### Policy Examples

**Allow specific group:**
```yaml
policy:
  - allow:
      groups:
        is: developers
```

**Allow multiple groups:**
```yaml
policy:
  - allow:
      or:
        - groups:
            is: developers
        - groups:
            is: admins
```

**Allow domain:**
```yaml
policy:
  - allow:
      email:
        ends_with: "@company.com"
```

**Combine conditions:**
```yaml
policy:
  - allow:
      and:
        - authenticated_user: true
        - groups:
            is: developers
        - email:
            ends_with: "@company.com"
```

## DNS Configuration

Configure DNS entries for Pomerium services (using Netbird Magic DNS or `/etc/hosts`):

```
100.64.0.2  authenticate.pomerium.local
100.64.0.2  dashboard.pomerium.local
100.64.0.2  app1.pomerium.local
100.64.0.2  app2.pomerium.local
100.64.0.2  admin.pomerium.local
```

Replace `100.64.0.2` with your VM2 Netbird IP.

## Zitadel Configuration

### Create OIDC Application in Zitadel

1. Log into https://gate.kappa4.com
2. Navigate to Applications â†’ New
3. Configure:
   - Name: Pomerium
   - Type: Web Application
   - Auth Method: POST
   - Redirect URIs:
     - `https://authenticate.pomerium.local/oauth2/callback`
     - `https://dashboard.pomerium.local/oauth2/callback`
   - Post Logout URIs:
     - `https://authenticate.pomerium.local/`
   - Grant Types: Authorization Code
   - Response Types: Code
   - Scopes: `openid`, `profile`, `email`, `groups`

4. Save Client ID and Client Secret
5. Update `/opt/pomerium/.env` with credentials

### Create Groups

Create groups in Zitadel for authorization:
- `pomerium-users` - Basic access
- `app1-users` - Access to App1
- `app2-users` - Access to App2
- `admin` - Admin access

Assign users to appropriate groups.

## Troubleshooting

### Pomerium not starting

Check logs:
```bash
sudo /opt/pomerium/logs.sh
```

Common issues:
- Missing or invalid environment variables
- Certificate issues
- Network connectivity

### Cannot access dashboard

1. Verify Netbird connection: `netbird status`
2. Check DNS resolution: `ping authenticate.pomerium.local`
3. Verify Pomerium is running: `docker ps`
4. Check firewall: `sudo ufw status`

### Authentication fails

1. Verify Zitadel application configuration
2. Check redirect URIs match exactly
3. Verify client ID and secret in `.env`
4. Check Pomerium logs for OIDC errors

### Authorization denied

1. Check user is in required group in Zitadel
2. Verify group claim is in token
3. Check policy in `config.yaml`
4. Review Pomerium logs for policy evaluation

## Security Notes

- All services accessible only through Netbird mesh network
- No public IP exposed on VM2
- TLS/HTTPS enforced everywhere
- MFA enforced at Zitadel level
- Group-based authorization
- Identity forwarded to backend applications

## Management Scripts

Located in `/opt/pomerium/`:

- `start.sh` - Start Pomerium
- `stop.sh` - Stop Pomerium
- `restart.sh` - Restart Pomerium
- `logs.sh` - View logs

## References

- [Full Integration Guide](../docs/pomerium-zitadel-integration.md)
- [Pomerium Documentation](https://www.pomerium.com/docs/)
- [Zitadel Documentation](https://zitadel.com/docs/)
- [Netbird Documentation](https://netbird.io/docs/)
